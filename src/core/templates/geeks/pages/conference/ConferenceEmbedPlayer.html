{% extends 'geeks/extends/foundation.html' %}

{% load static %}

{% block head_stylesheets %}
<style>
    {% include "core/includes/WebinarProgramStyles.html" %}
</style>
{% endblock head_stylesheets %}

{% block title %}
      <title>{{COMPANY_NAME}}</title>
{% endblock title %}

{% block root %}
<main>

    <section class="p-lg-2 py-3">
      <div class="container">
        <div class="row">
          
          
          {% if edition.chat %}
            <div class="col-lg-9 col-md-12 col-12 mb-5">
          {% else %}
            <div class="col-lg-12 col-md-12 col-12 mb-5">
          {% endif %}
            <div class="rounded-3 position-relative w-100 d-block overflow-hidden p-0" style="height: 500px">
              <iframe
                class="position-absolute top-0 end-0 start-0 end-0 bottom-0 h-100 w-100"
                width="560" height="315"
                {% if is_debug_mode %}
                src="https://www.youtube.com/embed/WO2b03Zdu4Q?si=qP9iJOCzwOb2xteT"
                {% else %}
                src="{{edition.stream_url_page}}"
                {% endif %}
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
                frameborder="0"></iframe>
            </div>
          </div>
          {% comment %} CHAT - END {% endcomment %}
          
          {% if edition.chat %}
          <div class="col-lg-3 col-md-12 col-12 mb-5">
            <div class="d-flex flex-column h-100 bg-light border rounded p-3">
                <h5 class="mb-3 border-bottom pb-2">Czat na żywo (&nbsp;<span id="live_count">0</span>&nbsp;)</h5>

                <!-- Kontener na wiadomości -->
                <div id="chat-messages" class="flex-grow-1" style="overflow-y: auto; min-height: 300px; max-height: 340px;">
                    <!-- Wiadomości będą wstawiane tutaj przez JavaScript -->
                    <div class="text-center text-muted mt-5">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Ładowanie wiadomości...</p>
                    </div>
                </div>

                <!-- Formularz do wysyłania wiadomości -->
                <div class="mt-3">
                    <form id="chat-form">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" id="chat-message-input" class="form-control" placeholder="Napisz wiadomość..."
                                maxlength="500" required>
                            <button class="btn btn-primary" type="submit" id="chat-message-submit">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <div id="char-counter" class="form-text text-end">0 / 500</div>
                    </form>
                </div>
            </div>
          </div>
          {% endif %}

        </div>

        <div class="row">
          {% if edition.advert_webinar_html %}
          <div class="col-12 {% if edition.advert_facebook_html %}col-lg-6{% endif %}">
            {{edition.advert_webinar_html|safe}}
          </div>
          {% endif %}
          {% if edition.advert_facebook_html %}
          <div class="col-12 {% if edition.advert_webinar_html %}col-lg-6{% endif %}">
            {{edition.advert_facebook_html|safe}}
          </div>
          {% endif %}
        </div>

        {% if advert_lecturer_aggragates %}
        <div class="row mb-4">
          <div class="col-12">
              <div class="card p-3">
              {% for aggregate in advert_lecturer_aggragates %}
              {% if aggregate.has_active_webinars %}
              {% include "geeks/pages/category/components/aggregate_row_card.html" with aggregate=aggregate %}
              {% endif %}
              {% endfor %}
              </div>
          </div>
        </div>
        {% endif %}

        {% if advert_category_aggregates %}
        <div class="row mb-4">
          <div class="col-12">
              <div class="card p-3">
              {% for aggregate in advert_category_aggregates %}
              {% if aggregate.has_active_webinars %}
              {% include "geeks/pages/category/components/aggregate_row_card.html" with aggregate=aggregate %}
              {% endif %}
              {% endfor %}
              </div>
          </div>
        </div>
        {% endif %}

        <!-- Content -->
        <div class="row">
          {% comment %} <div class="col-xl-8 col-lg-12 col-md-12 col-12 mb-4 mb-xl-0"> {% endcomment %}
          <div class="col-xl-12 col-lg-12 col-md-12 col-12 mb-4 mb-xl-0">
            <!-- Card -->
            <div class="card mb-2">
              <!-- Card body -->
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h1 class="fw-semibold mb-1">{{webinar.title}}</h1>
                  {% comment %} <a href="#" data-bs-toggle="tooltip" data-placement="top" aria-label="Add to Bookmarks" data-bs-original-title="Add to Bookmarks">
                  <i class="fe fe-bookmark fs-4 fs-3 text-inherit"></i>
                  </a> {% endcomment %}
                </div>
                <div class="d-flex mb-2 lh-1">

                    {% comment %} 
                  <span class="fs-6 align-top me-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"></path>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-star-half text-warning" viewBox="0 0 16 16">
                      <path d="M5.354 5.119 7.538.792A.516.516 0 0 1 8 .5c.183 0 .366.097.465.292l2.184 4.327 4.898.696A.537.537 0 0 1 16 6.32a.548.548 0 0 1-.17.445l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256a.52.52 0 0 1-.146.05c-.342.06-.668-.254-.6-.642l.83-4.73L.173 6.765a.55.55 0 0 1-.172-.403.58.58 0 0 1 .085-.302.513.513 0 0 1 .37-.245l4.898-.696zM8 12.027a.5.5 0 0 1 .232.056l3.686 1.894-.694-3.957a.565.565 0 0 1 .162-.505l2.907-2.77-4.052-.576a.525.525 0 0 1-.393-.288L8.001 2.223 8 2.226v9.8z">
                      </path>
                    </svg>
                  </span>
                  <span class="fw-medium">(140)</span>
                   <span class="ms-4 d-none d-md-block">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="8" width="2" height="6" rx="1" fill="#754FFE"></rect>
                      <rect x="7" y="5" width="2" height="9" rx="1" fill="#754FFE"></rect>
                      <rect x="11" y="2" width="2" height="12" rx="1" fill="#DBD8E9"></rect>
                    </svg>
                    <span>Intermediate</span>
                  </span>
                  <span class="ms-4 d-none d-md-block">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                      <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z">
                      </path>
                    </svg>
                    <span>Enrolled</span>
                  </span> {% endcomment %}
                </div>
                <div class="d-flex justify-content-between">
                  <div class="d-flex align-items-center">
                    <img src="{% get_media_prefix %}uploads/lecturers/{{webinar.lecturer.slug}}_50x50.webp" class="rounded-circle avatar-md" alt="{{webinar.lecturer.fullname}}">
                    <div class="ms-2 lh-1">
                      <h4 class="mb-1">{{webinar.lecturer.fullname}}</h4>
                      <p class="fs-6 mb-0">{{webinar.lecturer.profession}}</p>
                    </div>
                  </div>
                  {% comment %} <div>
                    <a href="#" class="btn btn-outline-secondary btn-sm">Follow</a>
                  </div> {% endcomment %}
                </div>
              </div>
              <!-- Nav tabs -->
              <ul class="nav nav-lt-tab" id="tab" role="tablist">
                <!-- Nav item -->
                <li class="nav-item" role="presentation">
                  <a class="nav-link active" id="description-tab" data-bs-toggle="pill" href="#description" role="tab" aria-controls="description" aria-selected="true">
                  Program szkolenia
                  </a>
                </li>
                <li class="nav-item" role="presentation">
                  <a class="nav-link" id="description-tab" data-bs-toggle="pill" href="#review" role="tab" aria-controls="description" aria-selected="true">
                  <b>Materiały szkoleniowe</b>
                  </a>
                </li>
                
              </ul>
            </div>
            <!-- Card -->
            <div class="card rounded-3">
              <!-- Card body -->
              <div class="card-body">
                <div class="tab-content" id="tabContent">
                  <!-- Tab pane -->
                  <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    
                    <div class="program-enriched fw-semibold lh-base">
                        {{webinar.program_pretty|safe}}
                    </div>

                    
                  </div>
                  <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
    
                    <section class="py-1">
                      <div class="container">
                         <div class="row">
                            <div class="col-xl-8 col-lg-8 col-md-12 col-12">
                               {% include "include/webinar_assets/assets_card.html" with webinar=webinar webinar_assets=webinar_assets assets_expired=assets_expired webinar_metadata=webinar_metadata %}
                            </div>
                            <div class="col-lg-4 col-md-12 col-12">
                              {% include "include/adverts/advert_lovalty_program.html" %}
                            </div>
                         </div>
                      </div>
                   </section>

                  </div>
                  <div class="tab-pane fade" id="transcript" role="tabpanel" aria-labelledby="transcript-tab">
                    <!-- Description -->
                    <div>
                      <h3 class="mb-3">Transcript from the "Introduction" Lesson</h3>
                      <div class="mb-4">
                        <h4>
                          Course Overview
                          <a href="#" class="ms-2 h4 text-primary">[00:00:00]</a>
                        </h4>
                        <p class="mb-0">
                          My name is John Deo and I work as human duct tape at Gatsby, that means that I do a lot of different things. Everything from dev roll to writing
                          content to writing code. And I used to work as an architect at IBM. I live in Portland, Oregon.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>
                          Introduction
                          <a href="#" class="ms-2 h4 text-primary">[00:00:16]</a>
                        </h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>
                          Why Take This Course?
                          <a href="#" class="ms-2 h4 text-primary">[00:00:37]</a>
                        </h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>
                          A Look at the Demo Application
                          <a href="#" class="ms-2 h4 text-primary">[00:00:54]</a>
                        </h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>
                          Summary
                          <a href="#" class="ms-2 h4 text-primary">[00:01:31]</a>
                        </h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="tab-pane fade" id="faq" role="tabpanel" aria-labelledby="faq-tab">
                    <!-- FAQ -->
                    <div>
                      <h3 class="mb-3">Course - Frequently Asked Questions</h3>
                      <div class="mb-4">
                        <h4>How this course help me to design layout?</h4>
                        <p>
                          My name is Jason Woo and I work as human duct tape at Gatsby, that means that I do a lot of different things. Everything from dev roll to
                          writing content to writing code. And I used to work as an architect at IBM. I live in Portland, Oregon.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>What is important of this course?</h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>Why Take This Course?</h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                      <div class="mb-4">
                        <h4>Is able to create application after this course?</h4>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                        <p>
                          We'll dive into GraphQL, the fundamentals of GraphQL. We're only gonna use the pieces of it that we need to build in Gatsby. We're not gonna be
                          doing a deep dive into what GraphQL is or the language specifics. We're also gonna get into MDX. MDX is a way to write React components in your
                          markdown.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>
{% endblock root %}


{% block body_scripts %}
<script>
    const chatId = '{{ edition.chat.id|default:"null" }}';
    const watchToken = '{{ free_participant.watch_token|default:"null" }}';
    const csrfToken = '{{ csrf_token }}';
    const heartbeatUrl = '{% url "api:participant-heartbeat" watch_token=free_participant.watch_token %}'
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('chat-message-input');
    const charCounter = document.getElementById('char-counter');
    const submitButton = document.getElementById('chat-message-submit');

    // Sprawdzamy, czy czat jest skonfigurowany dla tej edycji
    if (chatId === 'null' || watchToken === 'null') {
        chatMessages.innerHTML = '<p class="text-center text-muted mt-5">Czat jest niedostępny dla tej konferencji.</p>';
        messageInput.disabled = true;
        submitButton.disabled = true;
        return;
    }

    // URL do API
    const messagesListUrl = `/api/chat/${chatId}/messages/`;
    const messageCreateUrl = `/api/chat/${chatId}/messages/create/`;

    // --- FUNKCJE ---

    /**
     * Renderuje pojedynczą wiadomość w oknie czatu
     * @param {object} msg - Obiekt wiadomości
     */
    function renderMessage(msg) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-2');
        messageElement.innerHTML = `
            <div class="p-2 rounded bg-white shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <strong class="text-primary">${escapeHtml(msg.chat_user.first_name)}</strong>
                    <small class="text-muted">${msg.chat_user.first_name == "Moderator" ? "" : msg.created_at}</small>
                </div>
                <p class="mb-0 mt-1">${escapeHtml(msg.message)}</p>
            </div>
        `;
        return messageElement;
    }
    
    /**
     * Przewija okno czatu na sam dół
     */
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    /**
     * Pobiera i wyświetla wiadomości z serwera
     */
    async function fetchMessages() {
        try {
            const response = await fetch(messagesListUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const messages = await response.json();

            // Zapamiętujemy, czy użytkownik był na dole przed odświeżeniem
            const isScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 1;

            // Czyścimy kontener i renderujemy wiadomości
            chatMessages.innerHTML = '';
            if (messages.length > 0) {
                messages.forEach(msg => {
                    chatMessages.appendChild(renderMessage(msg));
                });
            } else {
                chatMessages.innerHTML = '<p class="text-center text-muted mt-5">Brak wiadomości. Bądź pierwszy!</p>';
            }
            
            // Jeśli użytkownik był na dole, przewijamy ponownie
            if (isScrolledToBottom) {
                scrollToBottom();
            }

        } catch (error) {
            console.error('Błąd podczas pobierania wiadomości:', error);
            chatMessages.innerHTML = '<p class="text-center text-danger mt-5">Nie udało się załadować wiadomości.</p>';
        }
    }

    /**
     * Wysyła nową wiadomość na serwer
     * @param {Event} e - Event formularza
     */
    async function postMessage(e) {
        e.preventDefault();
        const messageText = messageInput.value.trim();

        if (messageText === '') {
            return;
        }

        messageInput.disabled = true;
        messageInput.placeholder = 'Wysyłam wiadomość ...';
        messageInput.value = '';

        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;

        try {
            const response = await fetch(messageCreateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Watch-Token': watchToken,
                },
                body: JSON.stringify({ message: messageText }),
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            // Czyścimy pole i odświeżamy wiadomości
            messageInput.value = '';
            charCounter.textContent = 'Twoja wiadomość pojawi się po zatwierdzeniu przez administratora. Możesz wysłać kolejną wiadomość za 15 sekund.';
            // await fetchMessages();
            // scrollToBottom();
        } catch (error) {
            console.error('Błąd podczas wysyłania wiadomości:', error);
            alert(`Błąd: ${error.message}`); // W prawdziwej aplikacji lepiej użyć ładniejszego powiadomienia
        } finally {
          
          messageInput.placeholder = 'Wiadomość wysłana!';
          
          setTimeout(() => {
            messageInput.placeholder = 'Napisz wiadomość...';
            messageInput.disabled = false;
            submitButton.disabled = false;
            submitButton.innerHTML = `<i class="bi bi-send"></i>`;
            charCounter.textContent = '0 / 500';
          }, 15000);

        }
    }

    /**
     * Prosta funkcja do "uciekania" HTML, aby zapobiec XSS
     * @param {string} str - Ciąg znaków do przetworzenia
     */
    function escapeHtml(str) {
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // --- EVENT LISTENERS ---

    // Obsługa wysyłania formularza
    chatForm.addEventListener('submit', postMessage);

    // Licznik znaków w polu tekstowym
    messageInput.addEventListener('input', () => {
        const count = messageInput.value.length;
        charCounter.textContent = `${count} / 500`;
    });


    // --- INICJALIZACJA ---

    // Pobierz wiadomości przy pierwszym załadowaniu
    fetchMessages().then(() => {
        scrollToBottom();
    });

    // Ustaw interwał odświeżania wiadomości (co 5 sekund)
    setInterval(fetchMessages, 7000);
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Sprawdzamy, czy zmienne globalne zostały zdefiniowane w szablonie
    if (typeof heartbeatUrl === 'undefined' || typeof csrfToken === 'undefined') {
        console.error("Heartbeat script cannot start. Global variables `heartbeatUrl` and/or `csrfToken` are missing.");
        return; // Zakończ działanie skryptu, jeśli brakuje zmiennych
    }

    /**
     * Wysyła żądanie PATCH do serwera.
     */
    const sendHeartbeat = async () => {
        try {
            const response = await fetch(heartbeatUrl, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({}) // Ciało może być puste
            });

            const data = await response.json();
            console.log(data["active_count"]);

            const liveCountElement = document.getElementById('live_count');
            if (liveCountElement) {
              liveCountElement.innerHTML = data["active_count"];
            }

            if (!response.ok) {
                // Logujemy błąd, ale nie informujemy użytkownika
                console.error(`Heartbeat Error: Server responded with status ${response.status}`);
            }
        } catch (error) {
            console.error('Heartbeat Error: Network or other error occurred.', error);
        }
    };

    // Natychmiastowe uruchomienie pierwszego heartbeat'u po załadowaniu strony
    sendHeartbeat();

    // Ustawienie stałego interwału (15 sekund) dla kolejnych wywołań
    setInterval(sendHeartbeat, 15000);
});
</script>
{% endblock body_scripts %}